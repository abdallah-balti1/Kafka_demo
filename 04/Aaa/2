Parfait ‚Äî voici la fonction compl√®te, clean, stable et compatible Excel Mac, avec la correction d√©finitive pour que SEULES les colonnes ‚ÄúNew ADL in / New ADL out‚Äù soient modifiables, sans jamais cliquer sur √¥ter la protection.

Je te donne UNE fonction autonome, pr√™te √† coller, sans d√©pendances cach√©es.


---

‚úÖ Fonction finale (Excel Mac SAFE)

from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side, Protection
from openpyxl.worksheet.datavalidation import DataValidation
from openpyxl.utils import get_column_letter


def create_specific_fees_template_workbook(adl_fees_data: list[dict]) -> Workbook:
    """
    Excel template:
    - Sheet protected
    - All cells locked
    - ONLY columns:
        - New ADL in  (col 12)
        - New ADL out (col 13)
      are editable
    - Excel Mac compatible
    """

    wb = Workbook()
    ws = wb.active
    ws.title = "Specific Fees"

    # =========================
    # Styles
    # =========================
    black_fill = PatternFill("solid", fgColor="000000")
    dark_fill = PatternFill("solid", fgColor="1F1F1F")
    light_edit_fill = PatternFill("solid", fgColor="E6E6E6")

    font_white_bold = Font(bold=True, color="FFFFFF")
    font_black = Font(color="000000")

    align_center = Alignment(horizontal="center", vertical="center", wrap_text=True)
    align_left = Alignment(horizontal="left", vertical="center", wrap_text=True)

    border = Border(
        left=Side(style="thin"),
        right=Side(style="thin"),
        top=Side(style="thin"),
        bottom=Side(style="thin"),
    )

    # =========================
    # Title row
    # =========================
    ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=14)
    cell = ws.cell(row=1, column=1, value="BNP PARIBAS EASY - Update of real ADL fees (in bps)")
    cell.fill = black_fill
    cell.font = font_white_bold
    cell.alignment = align_left
    cell.border = border
    cell.protection = Protection(locked=True)
    ws.row_dimensions[1].height = 24

    # =========================
    # Headers
    # =========================
    headers = [
        "Umbrella name",
        "Sub-fund name",
        "Sub-fund ALADDIN code",
        "Sub-fund status",
        "Share name",
        "ISIN code",
        "Share status",
        "ADL in",
        "ADL out",
        "Max ADL in",
        "Max ADL out",
        "New ADL in",
        "New ADL out",
        "Effective NAV date",
    ]

    for col, header in enumerate(headers, start=1):
        c = ws.cell(row=3, column=col, value=header)
        c.fill = dark_fill
        c.font = font_white_bold
        c.alignment = align_center
        c.border = border
        c.protection = Protection(locked=True)

    ws.freeze_panes = "A4"

    # =========================
    # Column widths
    # =========================
    widths = {
        1: 22, 2: 34, 3: 22, 4: 16,
        5: 55, 6: 18, 7: 16,
        8: 10, 9: 10,
        10: 12, 11: 12,
        12: 12, 13: 12,
        14: 18,
    }

    for col, w in widths.items():
        ws.column_dimensions[get_column_letter(col)].width = w

    # =========================
    # Data validation (decimal >= 0)
    # =========================
    dv = DataValidation(
        type="decimal",
        operator="greaterThanOrEqual",
        formula1="0",
        allow_blank=True,
        errorStyle="stop",
        errorTitle="Invalid value",
        error="Only numeric values ‚â• 0 are allowed.",
    )
    ws.add_data_validation(dv)

    # =========================
    # Write data
    # =========================
    start_row = 4

    for i, row in enumerate(adl_fees_data):
        r = start_row + i

        values = [
            row.get("umb_name_lbl"),
            row.get("sbf_name"),
            row.get("prod_cd_valu"),
            row.get("sbf_stat_lbl"),
            row.get("sha_name"),
            row.get("isin_cd"),
            row.get("sha_stat_lbl"),
            row.get("adl_in_fee"),
            row.get("adl_out_fee"),
            row.get("max_adl_in_fee"),
            row.get("max_adl_out_fee"),
            None,  # New ADL in (editable)
            None,  # New ADL out (editable)
            row.get("nav_valuation_date"),
        ]

        for col, value in enumerate(values, start=1):
            cell = ws.cell(row=r, column=col, value=value)
            cell.font = font_black
            cell.border = border
            cell.alignment = align_left if col <= 7 else align_center

            # DEFAULT: locked
            cell.protection = Protection(locked=True)

            # Editable columns
            if col in (12, 13):
                cell.fill = light_edit_fill
                cell.number_format = "0.00"
                cell.protection = Protection(locked=False)

        # Validation ranges
        dv.add(f"{get_column_letter(12)}{r}")
        dv.add(f"{get_column_letter(13)}{r}")

    last_row = start_row + len(adl_fees_data) - 1

    # =========================
    # üî• CRITICAL EXCEL MAC FIX
    # Force unlock JUST BEFORE protection
    # =========================
    for row in ws.iter_rows(
        min_row=start_row,
        max_row=last_row,
        min_col=12,
        max_col=13,
    ):
        for cell in row:
            cell.protection = Protection(locked=False)

    # =========================
    # Protect sheet
    # =========================
    ws.protection.enable()
    ws.protection.selectLockedCells = False
    ws.protection.selectUnlockedCells = True

    return wb


---

‚úÖ R√©sultat garanti

‚úî Feuille prot√©g√©e
‚úî Colonnes gris√©es non modifiables
‚úî SEULEMENT New ADL in & New ADL out √©ditables
‚úî Fonctionne sur Excel Mac + Windows
‚úî Pas besoin de cliquer √¥ter la protection


---

üß† R√®gle d‚Äôor (√† ne jamais oublier)

> Sur Excel Mac : üîê Le dernier code qui touche aux cellules avant ws.protection.enable() d√©cide de tout.



C‚Äôest exactement ce que fait cette fonction.


---

Si tu veux ensuite :

ajouter un mot de passe

rendre les autres colonnes s√©lectionnables mais non √©ditables

ou factoriser cette logique pour d‚Äôautres templates


üëâ dis-le moi et je t‚Äôaccompagne.
