OK je vois les 2 probl√®mes sur tes screenshots :

1. Le style a chang√© parce que ta fonction cr√©e des PatternFill / Font ‚Äú√† la main‚Äù et n‚Äôutilise pas les m√™mes NamedStyle / couleurs que votre template g√©n√©rique.


2. Le probl√®me d‚Äô√©dition persiste parce qu‚Äôavec openpyxl, si tu appliques cell.style = ... (ou tu r√©√©cris des attributs de style) apr√®s avoir fait cell.protection = Protection(locked=False), Excel (surtout Mac) peut te remettre locked=True via le style.
‚û°Ô∏è La r√®gle : appliquer le style d‚Äôabord, puis l‚Äôunlock en dernier (ou mieux : utiliser un NamedStyle ‚Äúeditable‚Äù dont protection.locked=False).



Ci-dessous je te donne une fonction compl√®te clean, qui :

Reproduit un style proche de ton Excel (header noir/texte blanc, lignes gris√©es altern√©es, colonnes √©ditables gris clair)

Verrouille tout

D√©verrouille uniquement les colonnes 12 & 13 (New ADL in / out)

Ajoute une validation num√©rique (decimal >= 0) uniquement sur ces colonnes

Active la protection de feuille correctement



---

‚úÖ Fonction compl√®te (corrig√©e)

from openpyxl import Workbook
from openpyxl.styles import NamedStyle, Font, PatternFill, Alignment, Border, Side, Protection
from openpyxl.worksheet.datavalidation import DataValidation
from openpyxl.utils import get_column_letter


def create_specific_fees_template_workbook(adl_fees_data: list[dict]) -> Workbook:
    wb = Workbook()
    ws = wb.active
    ws.title = "Specific Fees"

    # -------------------------
    # Colors (proches de ton template)
    # -------------------------
    BLACK = "000000"
    DARK_GREY = "1F1F1F"
    GRID_GREY = "C0C0C0"
    ROW_EVEN = "F2F2F2"
    ROW_ODD = "FFFFFF"
    EDIT_GREY = "E6E6E6"

    # -------------------------
    # Base styles
    # -------------------------
    thin = Side(style="thin", color=GRID_GREY)
    BORDER = Border(left=thin, right=thin, top=thin, bottom=thin)

    font_title = Font(name="Verdana", size=11, bold=True, color="FFFFFF")
    font_header = Font(name="Verdana", size=11, bold=True, color="FFFFFF")
    font_data = Font(name="Verdana", size=11, color="000000")

    align_center = Alignment(horizontal="center", vertical="center", wrap_text=True)
    align_left = Alignment(horizontal="left", vertical="center", wrap_text=True)

    # IMPORTANT:
    # - styles LOCKED pour tout
    # - style EDITABLE unlocked uniquement pour col 12/13
    style_header = NamedStyle(name="sf_header")
    style_header.font = font_header
    style_header.fill = PatternFill("solid", fgColor=DARK_GREY)
    style_header.border = BORDER
    style_header.alignment = align_center
    style_header.protection = Protection(locked=True)

    style_even_locked = NamedStyle(name="sf_even_locked")
    style_even_locked.font = font_data
    style_even_locked.fill = PatternFill("solid", fgColor=ROW_EVEN)
    style_even_locked.border = BORDER
    style_even_locked.alignment = align_center
    style_even_locked.protection = Protection(locked=True)

    style_odd_locked = NamedStyle(name="sf_odd_locked")
    style_odd_locked.font = font_data
    style_odd_locked.fill = PatternFill("solid", fgColor=ROW_ODD)
    style_odd_locked.border = BORDER
    style_odd_locked.alignment = align_center
    style_odd_locked.protection = Protection(locked=True)

    style_even_locked_left = NamedStyle(name="sf_even_locked_left")
    style_even_locked_left.font = font_data
    style_even_locked_left.fill = PatternFill("solid", fgColor=ROW_EVEN)
    style_even_locked_left.border = BORDER
    style_even_locked_left.alignment = align_left
    style_even_locked_left.protection = Protection(locked=True)

    style_odd_locked_left = NamedStyle(name="sf_odd_locked_left")
    style_odd_locked_left.font = font_data
    style_odd_locked_left.fill = PatternFill("solid", fgColor=ROW_ODD)
    style_odd_locked_left.border = BORDER
    style_odd_locked_left.alignment = align_left
    style_odd_locked_left.protection = Protection(locked=True)

    style_editable = NamedStyle(name="sf_editable")
    style_editable.font = font_data
    style_editable.fill = PatternFill("solid", fgColor=EDIT_GREY)
    style_editable.border = BORDER
    style_editable.alignment = align_center
    style_editable.protection = Protection(locked=False)

    # Register styles safely (openpyxl peut contenir des strings dans wb.named_styles)
    existing = set([s if isinstance(s, str) else s.name for s in wb.named_styles])
    for st in [
        style_header,
        style_even_locked, style_odd_locked,
        style_even_locked_left, style_odd_locked_left,
        style_editable
    ]:
        if st.name not in existing:
            wb.add_named_style(st)
            existing.add(st.name)

    # -------------------------
    # Title row (row 1)
    # -------------------------
    ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=14)
    c = ws.cell(row=1, column=1, value="BNP PARIBAS EASY - Update of real ADL fees (in bps)")
    c.fill = PatternFill("solid", fgColor=BLACK)
    c.font = font_title
    c.alignment = align_left
    c.border = BORDER
    c.protection = Protection(locked=True)
    ws.row_dimensions[1].height = 24

    # -------------------------
    # Headers (row 3)
    # -------------------------
    headers = [
        "Umbrella name",
        "Sub-fund name",
        "Sub-fund ALADDIN code",
        "Sub-fund status",
        "Share name",
        "ISIN code",
        "Share status",
        "ADL in",
        "ADL out",
        "Max ADL in",
        "Max ADL out",
        "New ADL in",
        "New ADL out",
        "Effective NAV date",
    ]
    for col, h in enumerate(headers, start=1):
        cell = ws.cell(row=3, column=col, value=h)
        cell.style = "sf_header"

    ws.row_dimensions[3].height = 28
    ws.freeze_panes = "A4"

    # Column widths
    widths = {
        1: 22, 2: 34, 3: 22, 4: 16,
        5: 55, 6: 18, 7: 16,
        8: 10, 9: 10,
        10: 12, 11: 12,
        12: 12, 13: 12,
        14: 18,
    }
    for col, w in widths.items():
        ws.column_dimensions[get_column_letter(col)].width = w

    # -------------------------
    # Data validation (ONLY col 12/13)
    # -------------------------
    dv = DataValidation(
        type="decimal",
        operator="greaterThanOrEqual",
        formula1="0",
        allow_blank=True
    )
    dv.errorStyle = "stop"
    dv.errorTitle = "Invalid value"
    dv.error = "Only numeric values ‚â• 0 are allowed."
    ws.add_data_validation(dv)

    # -------------------------
    # Write data rows (start row 4)
    # -------------------------
    start_row = 4

    for i, row in enumerate(adl_fees_data):
        r = start_row + i

        values = [
            row.get("umb_name_lbl"),
            row.get("sbf_name"),
            row.get("prod_cd_valu"),
            row.get("sbf_stat_lbl"),
            row.get("sha_name"),
            row.get("isin_cd"),
            row.get("sha_stat_lbl"),
            row.get("adl_in_fee"),
            row.get("adl_out_fee"),
            row.get("max_adl_in_fee"),
            row.get("max_adl_out_fee"),
            None,  # New ADL in (editable)
            None,  # New ADL out (editable)
            row.get("nav_valuation_date"),
        ]

        is_even = (i % 2 == 0)

        for col, v in enumerate(values, start=1):
            cell = ws.cell(row=r, column=col, value=v)

            # Apply locked row style first
            if col <= 7:  # text columns
                cell.style = "sf_even_locked_left" if is_even else "sf_odd_locked_left"
            else:
                cell.style = "sf_even_locked" if is_even else "sf_odd_locked"

            # Formats
            if col in (8, 9, 10, 11, 12, 13):
                cell.number_format = "0.00"
            if col == 14:
                # si tu veux un format date, adapte selon ton besoin
                cell.number_format = "yyyymmdd"

            # ‚úÖ ONLY editable columns 12/13 => overwrite style with editable style (unlocked)
            if col in (12, 13):
                cell.style = "sf_editable"      # contains locked=False
                cell.number_format = "0.00"
                dv.add(cell)                    # apply validation cell by cell

    # -------------------------
    # Protect sheet (must be after unlocked cells exist)
    # -------------------------
    ws.protection.sheet = True
    ws.protection.selectLockedCells = False
    ws.protection.selectUnlockedCells = True

    return wb


---

üî• Important (√† v√©rifier c√¥t√© Excel)

Sur ton screenshot, tu cliques sur l‚Äôen-t√™te ‚ÄúNew ADL in‚Äù (ligne 3). La ligne des headers est toujours locked (normal).
üëâ Tu dois tester l‚Äô√©dition sur les cellules en dessous (√† partir de la ligne 4).


---

Pourquoi ton style avait chang√© ?

Parce que tu faisais un style ‚Äúcustom‚Äù diff√©rent du projet. Ici je t‚Äôai fait un style stable et proche de la capture. Si tu veux exactement le m√™me style que la template g√©n√©rique, colle-moi juste les constantes couleurs exactes (ou le bloc create_named_style complet) et je te l‚Äôaligne √† 100%.


---

Si tu veux, je peux aussi te donner la version qui r√©utilise vos constantes (LIGHT_GREY_COLOR, etc.) et qui s‚Äôint√®gre directement dans votre fichier get_mass_update_template.py sans changer le reste.
