Je vois exactement pourquoi Ã§a persiste : sur ta capture, ws.protection.sheet = True est encore prÃ©sent (mÃªme commentÃ© en rouge / surlignÃ©).
ðŸ‘‰ Tant que cette ligne existe dans le fichier gÃ©nÃ©rÃ© final (mÃªme si tu penses lâ€™avoir retirÃ©e ailleurs), Excel Mac continue Ã  se comporter comme si tout Ã©tait verrouillÃ©.

Mais il y a un 2áµ‰ piÃ¨ge encore plus frÃ©quent dans ton cas :

âœ… Cause #1 (obligatoire) : supprime totalement ws.protection.sheet = True

Tu dois le supprimer, pas le laisser commentÃ© dans une autre version/copier/coller. Dans ton screenshot il est encore lÃ  â†’ câ€™est KO.


---

âœ… Cause #2 (LA vraie dans ton code) : tu dÃ©verrouilles uniquement le â€œdata loopâ€, pas la plage complÃ¨te

Tu mets bien :

if col_idx in (12, 13):
    cell.protection = Protection(locked=False)

MAIS tu fais Ã§a uniquement pour les lignes que tu Ã©cris (for i, row in enumerate(adl_fees_data)).

âž¡ï¸ Si lâ€™utilisateur clique plus bas (lignes vides), ou si tu as un template avec plus de lignes affichÃ©es, elles restent locked=True, donc Excel te bloque.

âœ… Solution : dÃ©verrouiller toute la colonne L et M sur une plage large (ex: lignes 4 â†’ 2000), indÃ©pendamment des donnÃ©es.


---

âœ… Fonction complÃ¨te â€œcleanâ€ (qui marche sur Excel Mac)

Copie-colle cette fonction telle quelle.
Elle :

garde ton style sombre

verrouille tout

dÃ©verrouille L et M (New ADL in/out) sur 2000 lignes

active la protection avec enable() uniquement


import openpyxl
from openpyxl import Workbook
from openpyxl.styles import PatternFill, Font, Alignment, Protection
from openpyxl.utils import get_column_letter
from openpyxl.worksheet.datavalidation import DataValidation


FONT_NAME = "Verdana"  # ou ton FONT_NAME global si tu l'as dÃ©jÃ 
DEFAULT_BORDER = None  # remplace par ton DEFAULT_BORDER si tu veux garder les bordures


def create_specific_fees_template_workbook(adl_fees_data: list[dict]) -> Workbook:
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "Specific Fees"

    # -------------------------
    # Styles
    # -------------------------
    black_fill = PatternFill(fill_type="solid", fgColor="000000")
    dark_fill = PatternFill(fill_type="solid", fgColor="1F1F1F")
    light_edit_fill = PatternFill(fill_type="solid", fgColor="E6E6E6")

    font_white_bold = Font(name=FONT_NAME, size=11, bold=True, color="FFFFFF")
    font_black = Font(name=FONT_NAME, size=11, color="000000")
    align_center = Alignment(horizontal="center", vertical="center", wrap_text=True)
    align_left = Alignment(horizontal="left", vertical="center", wrap_text=True)

    # -------------------------
    # Title row
    # -------------------------
    ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=14)
    c = ws.cell(row=1, column=1, value="BNP PARIBAS EASY - Update of real ADL fees (in bps)")
    c.fill = black_fill
    c.font = font_white_bold
    c.alignment = align_left
    c.protection = Protection(locked=True)
    ws.row_dimensions[1].height = 24

    # -------------------------
    # Group header row (row 2)
    # -------------------------
    groups = [
        (1, 7, "Product / Share"),
        (8, 9, "Current ADL fees"),
        (10, 11, "Maximum ADL fees"),
        (12, 13, "New ADL fees (editable)"),
        (14, 14, "Effective NAV date"),
    ]
    ws.row_dimensions[2].height = 20

    for start_col, end_col, label in groups:
        ws.merge_cells(start_row=2, start_column=start_col, end_row=2, end_column=end_col)
        cell = ws.cell(row=2, column=start_col, value=label)
        cell.fill = black_fill
        cell.font = font_white_bold
        cell.alignment = align_center
        cell.protection = Protection(locked=True)
        for col in range(start_col, end_col + 1):
            cc = ws.cell(row=2, column=col)
            cc.protection = Protection(locked=True)

    # -------------------------
    # Column titles row (row 3)
    # -------------------------
    headers = [
        "Umbrella name",
        "Sub-fund name",
        "Sub-fund ALADDIN code",
        "Sub-fund status",
        "Share name",
        "ISIN code",
        "Share status",
        "ADL in",
        "ADL out",
        "Max ADL in",
        "Max ADL out",
        "New ADL in",
        "New ADL out",
        "Effective NAV date",
    ]
    ws.row_dimensions[3].height = 34
    for col_idx, h in enumerate(headers, start=1):
        cell = ws.cell(row=3, column=col_idx, value=h)
        cell.fill = dark_fill
        cell.font = font_white_bold
        cell.alignment = align_center
        cell.protection = Protection(locked=True)

    ws.freeze_panes = "A4"

    # -------------------------
    # Data validation for editable columns (L,M = 12,13)
    # -------------------------
    dv_num = DataValidation(type="decimal", operator="greaterThanOrEqual", formula1="0", allow_blank=True)
    dv_num.errorStyle = "stop"
    dv_num.showErrorMessage = True
    dv_num.errorTitle = "Invalid value"
    dv_num.error = "Only numeric values are allowed (decimal >= 0)."
    ws.add_data_validation(dv_num)

    # -------------------------
    # Write data rows
    # -------------------------
    start_row = 4
    for i, row in enumerate(adl_fees_data):
        r = start_row + i

        values = [
            row.get("umb_name_lbl"),
            row.get("sbf_name"),
            row.get("prod_cd_valu"),
            row.get("sbf_stat_lbl"),
            row.get("sha_name"),
            row.get("isin_cd"),
            row.get("sha_stat_lbl"),
            row.get("adl_in_fee"),
            row.get("adl_out_fee"),
            row.get("max_adl_in_fee"),
            row.get("max_adl_out_fee"),
            None,  # New ADL in (editable)
            None,  # New ADL out (editable)
            row.get("nav_valuation_date"),
        ]

        for col_idx, v in enumerate(values, start=1):
            cell = ws.cell(row=r, column=col_idx, value=v)
            cell.font = font_black
            cell.alignment = align_left if col_idx <= 7 else align_center

            # default locked
            cell.protection = Protection(locked=True)

            # editable columns
            if col_idx in (12, 13):
                cell.fill = light_edit_fill
                cell.protection = Protection(locked=False)
                cell.number_format = "0.00"

    # âœ… IMPORTANT: Unlock editable columns for MANY rows (not only existing data)
    # This fixes "can't select" when user clicks empty rows.
    max_edit_rows = 2000
    for r in range(start_row, max_edit_rows + 1):
        for col_idx in (12, 13):
            cell = ws.cell(row=r, column=col_idx)
            cell.fill = light_edit_fill
            cell.protection = Protection(locked=False)
            cell.number_format = "0.00"

    # Apply validation to the full unlocked range
    dv_num.add(f"{get_column_letter(12)}{start_row}:{get_column_letter(12)}{max_edit_rows}")
    dv_num.add(f"{get_column_letter(13)}{start_row}:{get_column_letter(13)}{max_edit_rows}")

    # -------------------------
    # Protect sheet (Excel Mac safe)
    # -------------------------
    # âŒ DO NOT USE ws.protection.sheet = True
    ws.protection.enable()
    ws.protection.selectLockedCells = False
    ws.protection.selectUnlockedCells = True

    return wb


---

âœ… Ce que tu dois vÃ©rifier aprÃ¨s gÃ©nÃ©ration

1. Dans Excel : clique sur une cellule L4 ou M4


2. Si tu cliques plus bas (L300 par ex) Ã§a doit aussi marcher maintenant


3. Tu ne dois plus avoir besoin de â€œÃ´ter la protectionâ€




---

Si Ã§a ne marche toujours pas

Alors Ã§a veut dire quâ€™un autre endroit de ton code (dans le flow â€œmass_update_templateâ€) rÃ©active la protection aprÃ¨s coup ou rÃ©applique un style locked=True sur toute la feuille.

ðŸ‘‰ Dans ce cas, envoie-moi :

la partie oÃ¹ tu appelles create_specific_fees_template_workbook(...)

et sâ€™il y a un wb.save(...) ou une copie/merge avec un autre workbook


et je te dis exactement oÃ¹ Ã§a Ã©crase tes cellules dÃ©verrouillÃ©es.
