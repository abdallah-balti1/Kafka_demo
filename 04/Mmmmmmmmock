// @flow
import { IntlProvider } from 'react-intl';
import { render, waitFor } from '@testing-library/react';
import { OBJECT_TYPE_ACTOR } from 'constants/objectTypes';
import { shallow } from 'enzyme';
import FormSubcategory from 'pages/Project/components/OperationalItems/components/FormSubcategory';

// Import the hooks
import { 
  useFetchMuActors, 
  useFetchDomiciliationCountries, 
  useFetchManagementCompanyLabels, 
  useFetchUmbrellaNameLabels 
} from 'redux/entities/massUpdateTemplates/hooks.js';

import { projectForUiFixture1 } from 'redux/entities/projects/tests/fixtures';
import { LoadingIndicatorWithPosition } from 'styles';

import MassUpdateProductSelection, {
  filterProducts,
  filterUmbrellas,
  type PropsType,
} from '../MassUpdateProductSelection';
import Style from '../MassUpdateProductSelection.style';

jest.mock('react-use', () => ({
  useAsync: jest.fn(),
}));

// Mock the hooks file
jest.mock('redux/entities/massUpdateTemplates/hooks.js', () => ({
  useFetchMuActors: jest.fn(),
  useFetchDomiciliationCountries: jest.fn(),
  useFetchManagementCompanyLabels: jest.fn(),
  useFetchUmbrellaNameLabels: jest.fn(),
}));

describe('<MassUpdateProductSelection>', () => {
  const productsSample = [
    {
      id: '11',
      name: '11',
      official_name: 'officialname11',
      type: 'SIN',
      juridiction: 'FRA',
      umbrellaId: '',
      statusCode: '1',
    },
    {
      id: '13',
      name: '13',
      official_name: 'officialname13',
      type: 'SIN',
      juridiction: 'FRA',
      umbrellaId: '',
      statusCode: '1',
    },
    {
      id: '139',
      name: '139',
      official_name: 'officialname139',
      type: 'SIN',
      juridiction: 'FRA',
      umbrellaId: '',
      statusCode: '1',
    },
  ];

  const umbrellasSample = {
    '11': {
      id: '11',
      name: '11',
      official_name: '11',
      domiciliationCountry: 'LUX',
      mgmt_comp_lbl: 'ubm1',
    },
    '13': {
      id: '13',
      name: '13',
      official_name: '13',
      domiciliationCountry: 'LUX',
      mgmt_comp_lbl: 'ubm1',
    },
    '139': {
      id: '139',
      name: '139',
      official_name: '139',
      domiciliationCountry: 'LUX',
      mgmt_comp_lbl: 'ubm1',
    },
  };

  describe('filterProducts', () => {
    it('should return products filtered list', () => {
      expect(filterProducts(productsSample, '')).toEqual([
        { id: '11', name: 'officialname11' },
        { id: '13', name: 'officialname13' },
        { id: '139', name: 'officialname139' },
      ]);
      expect(filterProducts(productsSample, 'officialname11')).toEqual([
        {
          id: '11',
          name: 'officialname11',
        },
      ]);
      expect(filterProducts(productsSample, 'x')).toEqual([]);
    });
  });

  describe('filterUmbrellas', () => {
    it('should return products filtered list', () => {
      expect(filterUmbrellas(umbrellasSample, '')).toEqual([
        { id: '11', name: '11' },
        { id: '13', name: '13' },
        { id: '139', name: '139' },
      ]);
      expect(filterUmbrellas(umbrellasSample, '13')).toEqual([
        { id: '13', name: '13' },
      ]);
      expect(filterUmbrellas(umbrellasSample, 'x')).toEqual([]);
    });
  });

  describe('MassUpdateProductSelection', () => {
    const mockFetchProducts = jest.fn();
    const mockFetchFilteredMuProducts = jest.fn();
    const mockFetchUmbrellas = jest.fn();
    const mockDownloadMassUpdateTemplate = jest.fn();
    const mockOnCloseClick = jest.fn();

    const defaultProps = {
      taskId: 123456,
      token: 'token',
      onCloseClick: mockOnCloseClick,
      downloadMassUpdateTemplate: mockDownloadMassUpdateTemplate,
      fetchProducts: mockFetchProducts,
      fetchFilteredMuProducts: mockFetchFilteredMuProducts,
      fetchUmbrellas: mockFetchUmbrellas,
      products: productsSample,
      filteredMuProducts: productsSample,
      umbrellas: umbrellasSample,
      // $FlowFixMe formik incomplete sample data is ok
      formik: { values: { selectedItems: [] }, setFieldValue: jest.fn() },
      project: {
        ...projectForUiFixture1,
        projectModel: {
          name: OBJECT_TYPE_ACTOR,
          id: 0,
          type: 'mass update actor',
          productTypes: null,
          isDeprecated: false,
          isTechnical: false,
        },
      },
      isLoading: false,
    };

    beforeEach(() => {
      jest.clearAllMocks();
      
      // --- FIX START: We cast these to 'any' to bypass Flow errors ---
      (useFetchMuActors: any).mockReturnValue({ value: [] });
      (useFetchDomiciliationCountries: any).mockReturnValue({ value: [] });
      (useFetchManagementCompanyLabels: any).mockReturnValue({ value: [] });
      (useFetchUmbrellaNameLabels: any).mockReturnValue({ value: [] });
      // --- FIX END ---
    });

    const wrapper = shallow(<MassUpdateProductSelection {...defaultProps} />);

    it('should render correctly', () => {
      expect(wrapper.find('FormSubcategory').length).toEqual(2);
      expect(wrapper.find(Style.FilterInputWithPlaceholder).length).toEqual(1);
      expect(wrapper.find(Style.AvailableList).length).toEqual(1);
      expect(wrapper.find(Style.ListSeparatorContainer).length).toEqual(1);
      expect(wrapper.find(Style.SelectedItems).length).toEqual(1);
      expect(wrapper.find('IconButton').length).toEqual(2);
      expect(wrapper.find(LoadingIndicatorWithPosition).length).toEqual(0);
    });

    it('should call fetchProducts when actors are loaded', async () => {
      const messages = {
        'MU_PRODUCTS_SELECTION.NO_PRODUCTS': 'MU_PRODUCTS_SELECTION.NO_PRODUCTS',
        LISTS_FILTER_PLACEHOLDER: 'LISTS_FILTER_PLACEHOLDER',
        Selection: 'Selection',
        'MODAL.ACTION.CONFIRM': 'MODAL.ACTION.CONFIRM',
        Products: 'Products',
        'MODAL.ACTION.CANCEL': 'MODAL.ACTION.CANCEL',
        MASSUPDATE_FILTERS: 'MASSUPDATE_FILTERS',
        Teams: 'Teams',
        'Actor Names': 'Actor Names',
      };

      // --- FIX START: Cast to 'any' here as well ---
      (useFetchMuActors: any).mockReturnValue({
        value: [
          {
            id: '1',
            actor_name: 'Doe',
            actor_first_name: 'John',
            uid: 'uid1',
            team_chg_lbl: 'Team1',
            team_chg_cd: 'cd1',
          },
        ],
      });
      // --- FIX END ---

      render(
        <IntlProvider locale="en" messages={messages}>
          <MassUpdateProductSelection {...defaultProps} />
        </IntlProvider>,
      );

      await waitFor(() => {
        expect(mockFetchProducts).toHaveBeenCalledWith('SIN', null, false);
      });
    });

    it('Mass update filters should render correctly', () => {
        const wrapperFilters = shallow(<MassUpdateProductSelection {...defaultProps} />);
        
        // Depending on your component logic, adding filters might increase this count
        // If the test fails on count, adjust based on how many filters actually render
        expect(wrapperFilters.find('FormSubcategory').length).toEqual(4); 

        const teamsSubcategory = wrapperFilters
          .find(FormSubcategory)
          .filterWhere((node) => node.prop('subcategoryLabel') === 'Teams');
        expect(teamsSubcategory).toHaveLength(1);

        const actorNamesSubcategory = wrapperFilters
          .find(FormSubcategory)
          .filterWhere((node) => node.prop('subcategoryLabel') === 'Actor Names');
        expect(actorNamesSubcategory).toHaveLength(1);
    });
  });
});
