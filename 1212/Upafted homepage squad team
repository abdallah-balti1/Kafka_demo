import React, { useState, useEffect } from "react";
import { getPocs } from "services/pocs";
import { Pocs } from "schemas/pocs";
import { decodeToken } from "utils/auth";
import Alert from "@mui/material/Alert";
import LockIcon from "@mui/icons-material/Lock";
import EventBusyIcon from "@mui/icons-material/EventBusy";
import AdminPanelSettingsIcon from "@mui/icons-material/AdminPanelSettings";

interface DecodedToken {
  role: string;
  userId: string;
  // Add other token properties as needed
}

interface UserPoc {
  user_id: string;
  poc_id: string;
  start_using: string;
  end_using: string;
  poc?: Pocs;
}

// Add the fetchUserPoc function
export const fetchUserPoc = async (userId: string): Promise<Pocs | null> => {
  try {
    const response = await axiosInstance.get(`/manage/pocs/user/${userId}`);
    const data = Array.isArray(response.data) ? response.data[0] : response.data;
    const poc = data?.poc;
    return poc ?? null;
  } catch (error) {
    console.error("Failed to fetch user POC:", error);
    return null;
  }
};

const HomePage = () => {
  const [pocs, setPocs] = useState<Pocs[]>([]);
  const [userPocs, setUserPocs] = useState<UserPoc[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [userRole, setUserRole] = useState<string>("guest");
  const [userId, setUserId] = useState<string>("");

  useEffect(() => {
    const token = localStorage.getItem("access_token");
    if (token) {
      try {
        const decoded = decodeToken(token) as DecodedToken;
        setUserRole(decoded.role || "guest");
        setUserId(decoded.userId || "");
      } catch (err) {
        console.error("Token decoding failed", err);
      }
    }
  }, []);

  const fetchData = async () => {
    try {
      if (userRole === "admin") {
        // Admin gets all POCs
        const response = await getPocs();
        setPocs(response);
      } else if (userRole === "poc_tester" || userRole === "squad_team") {
        // For poc_tester and squad_team, fetch their assigned POCs
        if (userId) {
          const userPocData = await fetchUserPoc(userId);
          if (userPocData) {
            setPocs([userPocData]);
          } else {
            setPocs([]);
          }
        }
      }
    } catch (err: any) {
      setError(err.message || "Failed to load data");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (userRole !== "guest" && (userRole === "admin" || userId)) {
      fetchData();
    } else if (userRole === "guest") {
      setLoading(false);
    }
  }, [userRole, userId]);

  // Check if user has access to a specific POC
  const hasAccessToPoc = (poc: Pocs): boolean => {
    if (userRole === "admin") {
      return true;
    }
    
    // For poc_tester and squad_team, check if the POC is in their assigned POCs
    // Since we're already filtering POCs in fetchData, if the POC is in the list, they have access
    return pocs.some(userPoc => userPoc.id === poc.id);
  };

  // Check if POC access is currently valid based on dates
  const isPocAccessValid = (poc: Pocs): boolean => {
    // If it's admin, use the original access_status
    if (userRole === "admin") {
      return poc.access_status === "is_active";
    }
    
    // For other roles, we would need to check the start_using and end_using dates
    // Since we don't have that data in the current POC object, we'll assume it's valid if they have access
    // You might want to modify the fetchUserPoc function to include this information
    return poc.access_status === "is_active";
  };

  const handlePocClick = (poc: Pocs) => {
    if (!hasAccessToPoc(poc)) {
      alert("You are not authorized to access this POC.");
      return;
    }

    if (!isPocAccessValid(poc)) {
      alert("Access to this POC has expired.");
      return;
    }

    if (poc.url) {
      window.open(poc.url, "_blank");
    } else {
      alert("No URL provided for this POC.");
    }
  };

  if (loading) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="text-center">
          <div className="flex flex-col items-center space-y-4">
            <div className="w-12 h-12 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
            <p className="text-gray-600 font-medium">Loading POCs...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-full flex items-center justify-center">
        <Alert severity="error" className="max-w-md">
          {error}
        </Alert>
      </div>
    );
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "admin_access":
        return (
          <span className="text-green-600 flex items-center">
            <AdminPanelSettingsIcon className="mr-1" style={{ fontSize: 16 }} />
            Admin Access
          </span>
        );
      case "is_active":
        return null;
      case "is_expired":
        return (
          <span className="text-orange-500 flex items-center">
            <EventBusyIcon className="mr-1" style={{ fontSize: 16 }} />
            Access Expired
          </span>
        );
      case "no_access":
      default:
        return (
          <span className="text-red-500 flex items-center">
            <LockIcon className="mr-1" style={{ fontSize: 16 }} />
            Not Authorized
          </span>
        );
    }
  };

  const getRoleDisplayName = (role: string) => {
    switch (role) {
      case "admin":
        return "Admin";
      case "poc_tester":
        return "POC Tester";
      case "squad_team":
        return "Squad Team";
      default:
        return "User";
    }
  };

  const getRoleDescription = (role: string) => {
    switch (role) {
      case "admin":
        return "You have access to all POCs";
      case "poc_tester":
        return "You have access to your assigned POC";
      case "squad_team":
        return "You have access to your assigned POCs";
      default:
        return "View your assigned POCs below";
    }
  };

  return (
    <div className="flex flex-col">
      <div className="text-center mb-8">
        <div className="flex justify-center mb-6">
          <img
            src="/AID_logo.png"
            alt="Company Logo"
            className="h-20 w-auto object-contain transition-transform hover:scale-105"
          />
        </div>
        <h1
          className="text-3xl font-bold text-gray-800 mb-2"
          style={{ fontFamily: "BNPP Sans, sans-serif" }}
        >
          Welcome {getRoleDisplayName(userRole)} to the Dashboard
        </h1>
        <p
          className="text-gray-600"
          style={{ fontFamily: "BNPP Sans, sans-serif" }}
        >
          {getRoleDescription(userRole)}
        </p>
      </div>

      <div className="flex flex-wrap justify-center gap-8">
        {pocs.length === 0 ? (
          <div className="text-center">
            <p className="text-gray-500 text-lg">
              {userRole === "admin" 
                ? "No POCs available" 
                : "No POCs assigned to you"}
            </p>
          </div>
        ) : (
          pocs.map((poc) => {
            const isAccessible = hasAccessToPoc(poc) && isPocAccessValid(poc);
            
            return (
              <div
                key={poc.id}
                onClick={() => isAccessible && handlePocClick(poc)}
                className={`bg-white shadow-lg rounded-xl p-6 border transition-all w-64 flex flex-col items-center ${
                  isAccessible
                    ? "cursor-pointer hover:shadow-xl hover:scale-105 border-gray-200"
                    : "cursor-not-allowed border-gray-100 opacity-70 grayscale"
                }`}
              >
                <div className="w-20 h-20 bg-gray-100 rounded-full mb-4 flex items-center justify-center">
                  <img
                    src={
                      poc.name === "My Referencial Assistant"
                        ? "/mra.png"
                        : "/vite.svg"
                    }
                    alt={poc.name}
                    className="w-16 h-16 object-contain"
                  />
                </div>
                <p
                  className={`text-center font-semibold ${
                    isAccessible ? "text-blue-600" : "text-gray-400"
                  }`}
                >
                  {poc.name}
                </p>
                <div className="mt-2 flex items-center text-xs">
                  {getStatusIcon(poc.access_status)}
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
};

export default HomePage;
